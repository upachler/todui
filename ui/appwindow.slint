import { Button, VerticalBox, HorizontalBox, LineEdit, CheckBox, ScrollView } from "std-widgets.slint";

export struct TodoItemData {
    text: string,
    completed: bool,
    indent-level: int,
}

export component AppWindow inherits Window {
    in property <string> window-title: "TODO";
    in property <[TodoItemData]> todo-items;

    callback toggle-item-completed(int);
    callback item-text-changed(int, string);
    callback indent-item-left(int);
    callback indent-item-right(int);
    callback delete-item(int);
    callback add-new-item();
    callback move-item(int, int);

    title: root.window-title;
    width: 800px;
    height: 600px;

    VerticalBox {
        padding: 16px;
        spacing: 16px;

        // Header
        Text {
            text: root.window-title;
            font-size: 24px;
            font-weight: 700;
            horizontal-alignment: center;
        }

        // Add new item button
        Button {
            text: "Add New Todo Item";
            clicked => {
                root.add-new-item();
            }
        }

        // Todo items list
        ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                spacing: 4px;

                for item[index] in root.todo-items: Rectangle {
                    height: 40px;
                    // background: item-area.is-dragging ? Colors.lightgreen :
                    //            (item-area.has-hover ? Colors.lightblue : Colors.black);
                    border-width: item-area.is-dragging ? 2px : 1px;
                    border-color: item-area.is-dragging ? Colors.green : Colors.lightgray;
                    drop-shadow-blur: item-area.is-dragging ? 4px : 0px;
                    drop-shadow-offset-y: item-area.is-dragging ? 2px : 0px;

                    item-area := TouchArea {
                        property <bool> is-dragging: false;
                        property <length> drag-start-y: 0;
                        property <int> drag-item-index: index;

                        pointer-event(event) => {
                            if (event.button == PointerEventButton.left) {
                                if (event.kind == PointerEventKind.down) {
                                    self.is-dragging = true;
                                    self.drag-start-y = self.mouse-y;
                                } else if (event.kind == PointerEventKind.up) {
                                    self.is-dragging = false;
                                }
                            } else if (event.kind == PointerEventKind.move) {
                                if (self.is-dragging) {
                                    // Calculate drop position based on mouse movement
                                    if (abs(self.mouse-y - self.drag-start-y) > 20px) {
                                        if (self.mouse-y > self.drag-start-y + 20px && index < root.todo-items.length - 1) {
                                            // Move down
                                            root.move-item(index, index + 1);
                                        } else if (self.mouse-y < self.drag-start-y - 20px && index > 0) {
                                            // Move up
                                            root.move-item(index, index - 1);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    HorizontalBox {
                        padding: 8px;
                        spacing: 8px;

                        // Drag handle
                        Rectangle {
                            width: 24px;
                            background: item-area.is-dragging ? Colors.darkgray :
                                       (item-area.has-hover ? Colors.lightgray : Colors.transparent);
                            border-radius: 3px;

                            Text {
                                text: "â‹®â‹®";
                                font-size: 14px;
                                color: item-area.is-dragging ? Colors.white : Colors.gray;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                font-weight: item-area.is-dragging ? 700 : 400;
                            }
                        }

                        // Indentation spacer
                        Rectangle {
                            width: item.indent-level * 20px;
                        }

                        // Checkbox
                        CheckBox {
                            checked: item.completed;
                            toggled => {
                                root.toggle-item-completed(index);
                            }
                        }

                        // Text input
                        LineEdit {
                            text: item.text;
                            horizontal-stretch: 1;
                            accepted(text) => {
                                root.item-text-changed(index, text);
                            }
                        }

                        // Indent left button
                        Button {
                            text: "<";
                            width: 30px;
                            enabled: item.indent-level > 0;
                            clicked => {
                                root.indent-item-left(index);
                            }
                        }

                        // Indent right button
                        Button {
                            text: ">";
                            width: 30px;
                            clicked => {
                                root.indent-item-right(index);
                            }
                        }

                        // Delete button
                        Button {
                            text: "ðŸ—‘";
                            width: 30px;
                            clicked => {
                                root.delete-item(index);
                            }
                        }
                    }
                }
            }
        }

        // Status bar
        Rectangle {
            height: 30px;
            background: Colors.lightgray;

            Text {
                text: @tr("Drag items by their handle (â‹®â‹®) to reorder them. Use checkboxes, text fields and buttons to interact. Changes are saved automatically.");
                vertical-alignment: center;
                horizontal-alignment: center;
                font-size: 12px;
            }
        }
    }
}
